using UnityEngine;
using Unity.Services.Analytics;
using UnityEngine.SceneManagement;
using Constants;


public class StageRunTracker : MonoBehaviour
{
    [Header("IDs")]
    [SerializeField] string stageId = "";
    [SerializeField] string gameplayMode = ""; // 외부에서 갱신
    public void SetGameplayMode(bool combat) => gameplayMode = combat ? "combat" : "stealth";

    float _startTime;
    int _attemptCount;
    int _killCount;
    bool _ended;

    private System.Action<Constants.GamePhase> _phaseHandler;

    void Awake()
    {
        stageId = SceneManager.GetActiveScene().name;

        // 게임 씬이 아니면 아예 꺼버리기 (중복 호출/오염 방지)
        if (!IsGameplayScene(stageId))
        {
            enabled = false;           // 또는 Destroy(this);
            return;
        }
    }
    public static bool IsGameplayScene(string scene)
    {
        // 네 규칙에 맞게 조정: 스테이지가 stage_ 접두사거나 tutorial이면 true
        return scene.StartsWith("stage_");
    }

    void OnEnable()
    {
        _attemptCount = PlayerPrefs.GetInt($"attempt_{stageId}", 0) + 1;
        PlayerPrefs.SetInt($"attempt_{stageId}", _attemptCount);
        _startTime = Time.time;
        _killCount = 0;
        _ended = false;

        var gm = GameManager.Instance;
        if (gm != null)
        {
            _phaseHandler = phase => SetGameplayMode(phase == Constants.GamePhase.Combat);
            gm.OnPhaseChanged += _phaseHandler;
        }
    }
    void OnDisable()
    {
        var gm = GameManager.Instance;
        if (gm != null && _phaseHandler != null)
        {
            gm.OnPhaseChanged -= _phaseHandler;
            _phaseHandler = null;
        }
    }

    // 적 처치 시 적 스크립트에서 호출: tracker.AddKill();
    public void AddKill() => _killCount++;

    // 클리어 순간(연출 직전/직후) 호출
    public void ReportComplete()
    {
        if (_ended) return;
        _ended = true;
        var playSec = Time.time - _startTime;
        GA.StageComplete(stageId, _attemptCount, playSec, _killCount, gameplayMode);
#if UNITY_WEBGL
        AnalyticsService.Instance.Flush();
#endif
        PlayerPrefs.DeleteKey($"attempt_{stageId}"); // 다음 스테이지 넘어간다면 초기화
    }

    // 실패 확정 순간 호출(게임오버, 시간초과 등)
    public void ReportFailed()
    {
        if (_ended) return;
        _ended = true;
        var playSec = Time.time - _startTime;
        GA.StageFailed(stageId, _attemptCount, playSec, _killCount, gameplayMode);
#if UNITY_WEBGL
        AnalyticsService.Instance.Flush();
#endif
        // 실패면 attempt 카운트 유지(다음 리트라이에서 +1)
    }
}
